<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-pap3YV" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="/css/styles.css?v=<%= Date.now() %>">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">

  <title>Document</title>
</head>
<body>
  <div class="container">
    <div class="h1-copy-wrapper">
      <h1>TRIM URL</h1>
    </div>

    <% if (error) { %>
      <div class="alert alert-danger"> 
        <% if (error === 'custom_taken') { %>
          Custom short code already in use. Choose another one.
        <% } else { %>
          An error occurred. Please try again.
        <% } %>
      </div>
    <% } %>

    <div class="d-flex flex-column flex-sm-row mb-4 align-items-center gap-2" style="justify-content:flex-start;">
      <div class="input-group" style="max-width:600px; width:100%;">
        <input id="search" class="form-control" placeholder="Search by code or URL" aria-label="Search by code or URL">
        <div class="input-group-append">
          <button id="searchBtn" class="btn btn-primary" type="button"><i class="fa fa-search"></i> Search</button>
        </div>
      </div>
      <button id="exportBtn" class="btn btn-info" title="Export all links to CSV"><i class="fa fa-download"></i> Export CSV</button>
    </div>

    <form id="addForm" action="/shortUrls" method="POST" style="display:block;">
      <div class="form-row">
        <div class="col-12 col-sm-6 mb-2 mb-sm-0">
          <input required placeholder="Enter URL" type="url" name="fullUrl" id="fullUrl" class="form-control">
        </div>
        <div class="col-12 col-sm-3 mb-2 mb-sm-0">
          <input placeholder="Custom code (optional)" type="text" name="customCode" id="customCode" class="form-control">
        </div>
        <div class="col-12 col-sm-3">
          <button class="btn btn-success btn-block" type="submit">Add Link</button>
        </div>
      </div>
    </form>

    <hr class="my-4">

    <div class="card" style="background-color: rgba(255, 255, 255, 0.95); border: 1px solid #dee2e6;">
      <div class="card-body p-0">
        <div class="table-responsive">
        <table class="table table-striped table-hover table-sm mb-0" id="linksTable">
      <thead>
        <tr>
          <th>Short Code</th>
          <th>Target URL</th>
          <th>QR Code</th>
          <th>Total Clicks</th>
          <th>Last Clicked</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% shortUrls.forEach(shortUrl => { %>
          <% const absolute = baseUrl ? (baseUrl.replace(/\/$/, '') + '/' + shortUrl.short) : ('/' + shortUrl.short) %>
          <tr data-code="<%= shortUrl.short %>" data-url="<%= shortUrl.full %>">
            <td class="align-middle short-cell text-truncate">
                <div class="d-flex align-items-center short-cell-inner">
                  <a href="<%= absolute %>" target="_blank" rel="noopener noreferrer" class="font-weight-bold text-primary short-code-link"><%= shortUrl.short %></a>
                  <button class="btn btn-outline-secondary btn-sm copy-btn" data-short="<%= shortUrl.short %>" title="Copy short URL"><i class="fa fa-copy"></i> copy</button>
                  <% if (shortUrl.createdAt && (new Date() - new Date(shortUrl.createdAt)) < 24*60*60*1000) { %>
                    <span class="badge badge-success ml-2">New</span>
                  <% } %>
                </div>
              </td>

            <td class="align-middle" style="max-width:480px;">
              <a href="<%= shortUrl.full %>" target="_blank" rel="noopener noreferrer" class="d-inline-block text-truncate" style="max-width:420px;"><%= shortUrl.full %></a>
            </td>

            <!-- UPDATED QR CODE SECTION -->
            <td class="align-middle text-center" style="width:120px;">
              <% if (shortUrl.qrImage) { %>
                <img 
                  src="<%= shortUrl.qrImage %>"
                  width="100"
                  height="100"
                  style="border:2px solid #1976d2; padding:4px; background:#f8f9fa; border-radius:6px;" 
                />
              <% } else { %>
                <span>No QR</span>
              <% } %>
            </td>

            <td class="align-middle text-center" style="width:90px;"><span class="badge badge-info"><%= shortUrl.clicks %></span></td>
            <td class="align-middle text-nowrap" style="width:180px;"><%= shortUrl.lastClicked ? (new Date(shortUrl.lastClicked)).toLocaleString() : 'â€”' %></td>

            <td class="align-middle text-right" style="width:120px;">
              <form action="/shortUrls/<%= shortUrl._id %>/delete" method="POST" style="display:inline" onsubmit="return confirmDelete(event)">
                <button class="btn btn-sm btn-danger" type="submit"><i class="fa fa-trash"></i> Delete</button>
              </form>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
        </div>
      </div>
    </div>

  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>

  <script>
    // Copy Button
    var lastCopiedBtn = null;
    document.querySelectorAll('.copy-btn').forEach(function (btn) {
      btn.addEventListener('click', function () {
        if (lastCopiedBtn && lastCopiedBtn !== btn) {
          lastCopiedBtn.innerHTML = '<i class="fa fa-copy"></i> copy';
        }

        var short = btn.getAttribute('data-short');
        var base = '<%= baseUrl || "" %>';
        var full = base ? base.replace(/\/$/, '') + '/' + short : window.location.origin + '/' + short;

        navigator.clipboard.writeText(full).then(function () {
          btn.innerHTML = '<i class="fa fa-check"></i> Copied';
          lastCopiedBtn = btn;
        });
      });
    });

    // Search
    function filterRows(q) {
      var query = (q || '').toLowerCase();
      var rows = document.querySelectorAll('#linksTable tbody tr');
      rows.forEach(function (r) {
        var code = (r.getAttribute('data-code') || '').toLowerCase();
        var url = (r.getAttribute('data-url') || '').toLowerCase();

        r.style.display = (code.indexOf(query) !== -1 || url.indexOf(query) !== -1) ? '' : 'none';
      });
    }

    document.getElementById('search').addEventListener('input', function (e) {
      filterRows(e.target.value);
    });

    document.getElementById('searchBtn').addEventListener('click', function () {
      filterRows(document.getElementById('search').value);
    });

    // Confirm delete
    function confirmDelete(e) {
      if (!confirm('Delete this short link? This action cannot be undone.')) {
        e.preventDefault();
        return false;
      }
      return true;
    }

    // Export CSV
    document.getElementById('exportBtn').addEventListener('click', function () {
      var rows = document.querySelectorAll('#linksTable tbody tr');
      var csv = 'Short Code,Target URL,Clicks,Last Clicked\n';

      rows.forEach(function (row) {
        if (row.style.display !== 'none') {
          var code = row.getAttribute('data-code');
          var url = row.getAttribute('data-url');
          var clicks = row.querySelector('td:nth-child(3)').innerText.trim();
          var lastClicked = row.querySelector('td:nth-child(4)').innerText.trim();

          csv += `"${code}","${url}",${clicks},"${lastClicked}"\n`;
        }
      });

      var blob = new Blob([csv], { type: 'text/csv' });
      var link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'shortlinks_' + new Date().toISOString().slice(0, 10) + '.csv';
      link.click();
    });

  </script>
</body>
</html>
